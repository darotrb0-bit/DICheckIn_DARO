<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>កម្មវិធីកត់ត្រាវត្តមាន</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- face-api.js for face recognition -->
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <!-- Google Fonts for a nice font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kantumruy+Pro:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Kantumruy Pro', sans-serif;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #3498db;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Style for the camera modal */
        #cameraModal {
            background-color: rgba(0, 0, 0, 0.6);
        }
        #videoContainer {
            position: relative;
            width: 100%;
            max-width: 500px;
            margin: auto;
        }
        #video, #overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 0.5rem;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">

    <div id="appContainer" class="w-full max-w-md bg-white rounded-lg shadow-xl p-8 space-y-6">
        <div class="text-center">
            <h1 class="text-2xl font-bold text-gray-800">ទម្រង់ចូលគណនី</h1>
            <p class="text-gray-500 mt-2">សូមជ្រើសរើសព័ត៌មានរបស់អ្នក</p>
        </div>

        <!-- Loading Indicator -->
        <div id="loader" class="flex flex-col items-center justify-center space-y-2">
            <div class="loader"></div>
            <p class="text-gray-500">កំពុងទាញទិន្នន័យ...</p>
        </div>

        <!-- Form Content -->
        <form id="accountForm" class="space-y-6 hidden">
            <!-- Class Input -->
            <div>
                <label for="classInput" class="block text-sm font-medium text-gray-700 mb-1">ជ្រើសរើស ឬវាយបញ្ចូលថ្នាក់រៀន</label>
                <input list="classList" id="classInput" name="classInput" class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" autocomplete="off">
                <datalist id="classList"></datalist>
            </div>

            <!-- ID Input -->
            <div>
                <label for="idInput" class="block text-sm font-medium text-gray-700 mb-1">ជ្រើសរើស ឬវាយបញ្ចូលអត្តលេខ</label>
                <input list="idList" id="idInput" name="idInput" class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" autocomplete="off" disabled>
                <datalist id="idList"></datalist>
            </div>

            <!-- Name Display -->
            <div class="bg-gray-50 p-4 rounded-md text-center">
                <label class="text-sm font-medium text-gray-500">ឈ្មោះសិស្ស</label>
                <p id="nameDisplay" class="text-xl font-bold text-indigo-600 mt-1">-</p>
            </div>
        </form>
         <p id="error-message" class="text-center text-red-500 hidden"></p>
    </div>

    <!-- Home Page UI (hidden by default) -->
    <div id="homePage" class="w-full max-w-md bg-white rounded-lg shadow-xl p-8 space-y-6 text-center hidden">
        <svg class="mx-auto h-16 w-16 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <h1 class="text-2xl font-bold text-gray-800">ការផ្ទៀងផ្ទាត់ជោគជ័យ!</h1>
        <p class="text-gray-600 text-lg">សូមស្វាគមន៍, <span id="homeName" class="font-bold"></span>!</p>
    </div>


    <!-- Camera Verification Modal -->
    <div id="cameraModal" class="fixed inset-0 w-full h-full flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg text-center">
            <h2 class="text-xl font-bold mb-4">សូមដាក់មុខនៅចំកណ្តាល</h2>
            <div id="videoContainer" class="w-full aspect-video bg-gray-900 rounded-lg mb-4">
                 <video id="video" autoplay muted playsinline></video>
                 <canvas id="overlay"></canvas>
            </div>
            <p id="cameraStatus" class="text-gray-600 mb-4 h-6">កំពុងចាប់ផ្តើមកាមេរ៉ា...</p>
            <button id="closeModalButton" class="bg-red-500 text-white font-bold py-2 px-6 rounded-md hover:bg-red-600">បោះបង់</button>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // --- Configuration ---
            const SHEET_ID = '1eRyPoifzyvB4oBmruNyXcoKMKPRqjk6xDD6-bPNW6pc';
            const SHEET_NAME = 'DIList';
            const RANGE = 'E9:AA';
            const URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${SHEET_NAME}&range=${RANGE}`;

            // --- DOM Elements ---
            const loader = document.getElementById('loader');
            const appContainer = document.getElementById('appContainer');
            const accountForm = document.getElementById('accountForm');
            const classInput = document.getElementById('classInput');
            const idInput = document.getElementById('idInput');
            const nameDisplay = document.getElementById('nameDisplay');
            const classDatalist = document.getElementById('classList');
            const idDatalist = document.getElementById('idList');
            const errorMessage = document.getElementById('error-message');
            const homePage = document.getElementById('homePage');
            const homeName = document.getElementById('homeName');

            // Camera Modal Elements
            const cameraModal = document.getElementById('cameraModal');
            const video = document.getElementById('video');
            const overlay = document.getElementById('overlay');
            const cameraStatus = document.getElementById('cameraStatus');
            const closeModalButton = document.getElementById('closeModalButton');
            
            // --- State ---
            let studentData = [];
            let currentStudent = null;
            let faceMatcher = null;
            let videoInterval = null;
            let areModelsLoaded = false;

            // --- Load Face API Models ---
            async function loadModels() {
                // Use the standard NPM CDN for better reliability
                const MODEL_URL = 'https://cdn.jsdelivr.net/gh/justadudewhohacks/face-api.js@0.22.2/weights';
                console.log('Loading face recognition models...');
                try {
                    // Using SsdMobilenetv1 for higher accuracy than TinyFaceDetector
                    await faceapi.nets.ssdMobilenetv1.loadFromUri(MODEL_URL);
                    await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL);
                    await faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL);
                    console.log('Models loaded successfully.');
                    areModelsLoaded = true;
                } catch (error) {
                    console.error("Error loading models: ", error);
                    errorMessage.textContent = 'បរាជ័យក្នុងការទាញយកម៉ូដែលវិភាគមុខ។';
                    errorMessage.classList.remove('hidden');
                }
            }
            
            async function fetchData() {
                try {
                    const response = await fetch(URL);
                    if (!response.ok) throw new Error(`Network response error: ${response.status}`);
                    
                    const text = await response.text();
                    const jsonString = text.substring(text.indexOf('(') + 1, text.lastIndexOf(')'));
                    const data = JSON.parse(jsonString);

                    if (data.status === 'error') throw new Error(data.errors.map(e => e.detailed_message).join(', '));

                    // E=0, L=7, R=13, AA=22
                    studentData = data.table.rows.map(row => {
                        if (!row || !row.c) return null;
                        const id = row.c[0]?.v;
                        const name = row.c[7]?.v;
                        const className = row.c[13]?.v;
                        let imageUrl = row.c[22]?.v;

                        // Use a proxy for Google Drive images to prevent CORS issues
                        if (imageUrl && imageUrl.includes('drive.google.com')) {
                           imageUrl = `https://images.weserv.nl/?url=${encodeURIComponent(imageUrl.replace('/file/d/', '/uc?export=view&id='))}`;
                        }
                        
                        if (id && name && className && imageUrl) {
                            return { id: String(id), name: String(name), class: String(className), imageUrl };
                        }
                        return null;
                    }).filter(Boolean);

                    populateClasses();
                    loader.classList.add('hidden');
                    accountForm.classList.remove('hidden');
                } catch (error) {
                    console.error('Error fetching data:', error);
                    loader.classList.add('hidden');
                    errorMessage.textContent = 'បរាជ័យក្នុងការទាញទិន្នន័យ។';
                    errorMessage.classList.remove('hidden');
                }
            }

            function populateClasses() {
                const uniqueClasses = [...new Set(studentData.map(item => item.class))];
                classDatalist.innerHTML = '';
                uniqueClasses.sort().forEach(className => {
                    const option = document.createElement('option');
                    option.value = className;
                    classDatalist.appendChild(option);
                });
            }

            function handleClassChange() {
                idDatalist.innerHTML = '';
                idInput.value = '';
                nameDisplay.textContent = '-';
                currentStudent = null;

                const filteredData = studentData.filter(item => item.class === classInput.value);
                if (filteredData.length > 0) {
                    filteredData.forEach(item => {
                        const option = document.createElement('option');
                        option.value = item.id;
                        idDatalist.appendChild(option);
                    });
                    idInput.disabled = false;
                } else {
                    idInput.disabled = true;
                }
            }

            async function handleIdChange() {
                currentStudent = studentData.find(item => item.id === idInput.value);
                
                if (currentStudent) {
                    nameDisplay.textContent = currentStudent.name;
                    await startVerification();
                } else {
                    nameDisplay.textContent = '-';
                }
            }

            async function startVerification() {
                if (!currentStudent) return;
                
                cameraModal.classList.remove('hidden');

                if (!areModelsLoaded) {
                    cameraStatus.textContent = 'សូមរង់ចាំ, កំពុងទាញយកម៉ូដែល...';
                    await new Promise(resolve => {
                        const checkInterval = setInterval(() => {
                            if (areModelsLoaded) {
                                clearInterval(checkInterval);
                                resolve();
                            }
                        }, 100);
                    });
                }
                
                cameraStatus.textContent = 'កំពុងរៀបចំ...';
                
                try {
                    const detectionOptions = new faceapi.SsdMobilenetv1Options({ minConfidence: 0.5 });
                    cameraStatus.textContent = 'កំពុងដំណើរការរូបថតយោង...';
                    const referenceImage = await faceapi.fetchImage(currentStudent.imageUrl);
                    const referenceDetection = await faceapi.detectSingleFace(referenceImage, detectionOptions).withFaceLandmarks().withFaceDescriptor();
                    
                    if (!referenceDetection) {
                        throw new Error("មិនអាចរកឃើញមុខនៅក្នុងរូបថតយោងបានទេ។");
                    }
                    faceMatcher = new faceapi.FaceMatcher([referenceDetection.descriptor]);

                    cameraStatus.textContent = 'កំពុងស្នើសុំកាមេរ៉ា...';
                    const stream = await navigator.mediaDevices.getUserMedia({ video: {} });
                    video.srcObject = stream;
                    video.addEventListener('play', onVideoPlay);

                } catch (error) {
                    console.error("Verification Error:", error);
                    cameraStatus.textContent = `មានបញ្ហា: ${error.message}`;
                    setTimeout(closeVerificationModal, 3000);
                }
            }

            function onVideoPlay() {
                const videoEl = video;
                const canvasEl = overlay;
                
                canvasEl.width = videoEl.videoWidth;
                canvasEl.height = videoEl.videoHeight;

                // Use more stringent options for live video to improve performance
                const detectionOptions = new faceapi.SsdMobilenetv1Options({ minConfidence: 0.8 });

                videoInterval = setInterval(async () => {
                    if (!faceMatcher) return;

                    const detections = await faceapi.detectAllFaces(videoEl, detectionOptions).withFaceLandmarks().withFaceDescriptors();
                    const context = canvasEl.getContext('2d');
                    context.clearRect(0, 0, canvasEl.width, canvasEl.height);
                    
                    if (detections.length > 0) {
                        const resizedDetections = faceapi.resizeResults(detections, { width: canvasEl.width, height: canvasEl.height });
                        faceapi.draw.drawDetections(canvasEl, resizedDetections);
                        
                        const bestMatch = faceMatcher.findBestMatch(detections[0].descriptor);
                        cameraStatus.textContent = `ការផ្ទៀងផ្ទាត់... (${(1 - bestMatch.distance).toFixed(2)})`;
                        
                        // A distance threshold of 0.5 is good for high confidence. 
                        // Lower values (e.g., 0.4) are more strict.
                        if (bestMatch.label !== 'unknown' && bestMatch.distance < 0.5) { 
                           verificationSuccess();
                        }
                    } else {
                        cameraStatus.textContent = 'រកមិនឃើញមុខ';
                    }
                }, 300);
            }

            function verificationSuccess() {
                clearInterval(videoInterval);
                closeVerificationModal();
                appContainer.classList.add('hidden');
                homeName.textContent = currentStudent.name;
                homePage.classList.remove('hidden');
            }

            function closeVerificationModal() {
                clearInterval(videoInterval);
                if (video.srcObject) {
                    video.srcObject.getTracks().forEach(track => track.stop());
                    video.srcObject = null;
                }
                cameraModal.classList.add('hidden');
                // Reset input fields if verification is cancelled by user
                if (idInput.value) {
                    idInput.value = '';
                    nameDisplay.textContent = '-';
                }
            }

            // --- Event Listeners ---
            classInput.addEventListener('change', handleClassChange);
            idInput.addEventListener('change', handleIdChange);
            closeModalButton.addEventListener('click', closeVerificationModal);

            // --- Initial Load ---
            loadModels();
            fetchData();
        });
    </script>

</body>
</html>

